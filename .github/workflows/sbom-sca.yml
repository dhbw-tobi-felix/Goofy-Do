name: SBOM + SCA
run-name: >
  ${{ format('SBOM/SCA • {0} • {1}', github.event_name, github.ref_name || format('PR #{0}', github.event.pull_request.number)) }}

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  security-events: write

jobs:
  sbom_sca:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: ${{ github.event_name == 'pull_request' }}

      # --- Tools ---
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0
        with:
          syft-version: v1.16.0

      - name: Install Trivy + jq
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y wget jq
          TRIVY_VERSION=0.56.1
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz | tar xz
          sudo mv trivy /usr/local/bin/

      # ---------- Builds ----------
      - name: Build backend (Quarkus)
        working-directory: backend
        run: ./gradlew quarkusBuild --no-daemon --quiet

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      # ---------- SBOMs ----------
      - name: Backend Project SBOM (CycloneDX, via Trivy)
        run: |
          set -euxo pipefail
          trivy fs backend \
            --format cyclonedx \
            --output sbom-backend-project.cdx.json \
            --skip-dirs backend/build

      - name: Backend Runtime SBOM (SPDX, via Syft)
        run: |
          set -euxo pipefail
          syft scan dir:backend/build/quarkus-app/lib -o spdx-json=sbom-backend-runtime.spdx.json
          test -s sbom-backend-runtime.spdx.json

      - name: Frontend SBOM (CycloneDX, via Trivy)
        run: |
          set -euxo pipefail
          trivy fs frontend \
            --format cyclonedx \
            --output sbom-frontend.cdx.json \
            --skip-dirs frontend/node_modules

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-backend-project.cdx.json
            sbom-backend-runtime.spdx.json
            sbom-frontend.cdx.json

      # ---------- SCA ----------
      - name: SCA (backend via SBOM)
        run: |
          set -euxo pipefail
          trivy sbom sbom-backend-runtime.spdx.json \
            --format json \
            --ignore-unfixed \
            --exit-code 0 \
            -o sca-backend.json
          jq -e '
            [
              .Results[]?.Vulnerabilities[]?
              | select(
                  (.Severity=="HIGH") or
                  (.Severity=="CRITICAL") or
                  ((.CVSS.nvd.v3Score // .CVSS.redhat.v3Score // .CVSS.github.v3Score // 0) >= 7)
                )
            ] | length == 0
          ' sca-backend.json \
          || { echo "SCA gate failed (backend): HIGH/CRITICAL oder CVSS>=7"; exit 1; }

      - name: SCA (frontend via SBOM)
        run: |
          set -euxo pipefail
          trivy sbom sbom-frontend.cdx.json \
            --format json \
            --ignore-unfixed \
            --exit-code 0 \
            -o sca-frontend.json
          jq -e '
            [
              .Results[]?.Vulnerabilities[]?
              | select(
                  (.Severity=="HIGH") or
                  (.Severity=="CRITICAL") or
                  ((.CVSS.nvd.v3Score // .CVSS.redhat.v3Score // .CVSS.github.v3Score // 0) >= 7)
                )
            ] | length == 0
          ' sca-frontend.json \
          || { echo "SCA gate failed (frontend): HIGH/CRITICAL oder CVSS>=7"; exit 1; }

      # ---------- SARIF ----------
      - name: Prepare reports dir
        if: always()
        run: mkdir -p reports

      - name: SCA (Backend) als SARIF erzeugen
        if: always()
        run: |
          set -euxo pipefail
          trivy sbom sbom-backend-runtime.spdx.json \
            --format sarif \
            --ignore-unfixed \
            --exit-code 0 \
            -o reports/sca-backend.sarif
          test -s reports/sca-backend.sarif

      - name: SCA (Frontend) als SARIF erzeugen
        if: always()
        run: |
          set -euxo pipefail
          trivy sbom sbom-frontend.cdx.json \
            --format sarif \
            --ignore-unfixed \
            --exit-code 0 \
            -o reports/sca-frontend.sarif
          test -s reports/sca-frontend.sarif

      - name: Debug report presence
        if: always()
        run: |
          pwd
          ls -la
          ls -la reports || true

      # --- upload to Security tab ---
      - name: Upload SARIF (backend)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/sca-backend.sarif
          category: trivy-backend
          wait-for-processing: true

      - name: Upload SARIF (frontend)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/sca-frontend.sarif
          category: trivy-frontend
          wait-for-processing: true

      - name: Upload SCA reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-reports
          path: |
            sca-backend.json
            sca-frontend.json
            reports